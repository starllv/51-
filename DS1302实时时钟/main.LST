C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include<reg51.h>
   2          #include"ds1302.h"
   3          #include"lcd.h"
   4          
   5          #define uchar unsigned char
   6          #define uint unsigned int
   7          
   8          sbit s1=P2^0;
   9          sbit s2=P2^1;
  10          sbit s3=P2^2;
  11          sbit s4=P2^3;
  12          sbit beep=P2^4;
  13          
  14          bit flag1,flag_ri;
  15          uchar count,s1num,flag,t0_num;
  16          uchar day,month,week,amiao,afen,ashi;
  17          uint miao,shi,fen,year;
  18          uchar table[]=" 20  -  -       ";
  19          uchar table1[]="      :  :  ";
  20          
  21          void delay(uint x){
  22   1              uchar y;
  23   1              for(x;x>0;x--)
  24   1                      for(y=110;y>0;y--);
  25   1      }
  26          
  27          void di(){
  28   1              uchar n;
  29   1              for(n=0;n<8;n++){
  30   2                      beep=0;
  31   2                      delay(10);
  32   2                      beep=1;
  33   2                      delay(10);
  34   2              }
  35   1      }
  36          
  37          void write_sfm(uchar add,char date){
  38   1              char shi,ge;
  39   1              shi=date/10;
  40   1              ge=date%10;
  41   1              writecom(0x80+0x40+add);
  42   1              writedata('0'+shi);
  43   1              writedata('0'+ge);
  44   1      }
  45          
  46          void write_sfm_bcd(uchar add,char date){
  47   1              char shi,ge;
  48   1              shi=date/16;
  49   1              ge=date&0x0f;
  50   1              writecom(0x80+0x40+add);
  51   1              writedata('0'+shi);
  52   1              writedata('0'+ge);
  53   1      }
  54          
  55          void write_nyr(uchar add,char date){
C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 2   

  56   1              char shi,ge;
  57   1              shi=date/10;
  58   1              ge=date%10;
  59   1              writecom(0x80+add);
  60   1              writedata('0'+shi);
  61   1              writedata('0'+ge);      
  62   1      }
  63          
  64          void write_nyr_bcd(uchar add,char date){
  65   1              char shi,ge;
  66   1              shi=date/16;
  67   1              ge=date&0x0f;
  68   1              writecom(0x80+add);
  69   1              writedata('0'+shi);
  70   1              writedata('0'+ge);      
  71   1      }
  72          
  73          void write_week(char we){
  74   1              writecom(0x80+12);
  75   1              switch(we)
  76   1              {
  77   2                      case 1: writedata('M');delay(5);
  78   2                                      writedata('O');delay(5);
  79   2                                      writedata('N');
  80   2                                      break;
  81   2                      case 2: writedata('T');delay(5);
  82   2                                      writedata('U');delay(5);
  83   2                                      writedata('E');
  84   2                                      break;
  85   2                      case 3: writedata('W');delay(5);
  86   2                                      writedata('E');delay(5);
  87   2                                      writedata('D');
  88   2                                      break;
  89   2                      case 4: writedata('T');delay(5);
  90   2                                      writedata('H');delay(5);
  91   2                                      writedata('U');
  92   2                                      break;
  93   2                      case 5: writedata('F');delay(5);
  94   2                                      writedata('R');delay(5);
  95   2                                      writedata('I');
  96   2                                      break;
  97   2                      case 6: writedata('S');delay(5);
  98   2                                      writedata('A');delay(5);
  99   2                                      writedata('T');
 100   2                                      break;
 101   2                      case 7: writedata('S');delay(5);
 102   2                                      writedata('U');delay(5);
 103   2                                      writedata('N');
 104   2                                      break;
 105   2              }
 106   1      }
 107          
 108          uchar shi_bcd(uchar num){
 109   1              return (((num/10)<<3)|(num%10));        
 110   1      }
 111          //void read_alarm(){
 112          //      amiao=read_ds(0x81);
 113          //      afen=read_ds(0x83);
 114          //      ashi=read_ds(0x85);
 115          //}
 116          
 117          void init(){
C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 3   

 118   1              uchar num;
 119   1      //      EA=1;
 120   1      //      EX1=1;
 121   1      //      IT1=1;
 122   1              flag1=0;
 123   1              t0_num=0;
 124   1              s1num=0;
 125   1              week=1;
 126   1              set_time();
 127   1              lcdinit();
 128   1              for(num=0;num<15;num++){
 129   2                      writedata(table[num]);
 130   2                      delay(1);
 131   2              }
 132   1              writecom(0x80+0x40);
 133   1              for(num=0;num<11;num++){
 134   2                      writedata(table1[num]);
 135   2                      delay(1);
 136   2              }
 137   1      }
 138          
 139          void keyscan(){
 140   1      //      if(flag_ri==1){
 141   1      //              if((s1==0)||(s2==0)||(s3==0)||(s4==0)){
 142   1      //                      delay(5);
 143   1      //                      if((s1==0)||(s2==0)||(s3==0)||(s4==0)){
 144   1      //                              while(!(s1&&s2&&s3&&s4));di();
 145   1      //                              flag_ri=0;
 146   1      //                      }
 147   1      //              }
 148   1      //      }
 149   1      
 150   1              if(s1==0){
 151   2                      delay(5);
 152   2                      if(s1==0){
 153   3                              s1num++;
 154   3      //                      if(flag1==1){
 155   3      //                              if(s1num==4)s1num=1;
 156   3      //                      }
 157   3                              flag=1;
 158   3                              while(!s1);di();
 159   3                              switch(s1num)
 160   3                              {
 161   4                                      case 1: writecom(0x80+0x40+10);
 162   4                                                      writecom(0x0f);
 163   4                                                      break;
 164   4                                      case 2: writecom(0x80+0x40+7);
 165   4                                                      break;
 166   4                                      case 3: writecom(0x80+0x40+4);
 167   4                                                      break;
 168   4                                      case 4: writecom(0x80+12);
 169   4                                                      break;
 170   4                                      case 5: writecom(0x80+9);
 171   4                                                      break;
 172   4                                      case 6: writecom(0x80+6);
 173   4                                                      break;
 174   4                                      case 7: writecom(0x80+3);
 175   4                                                      break;
 176   4                                      case 8: s1num=0;
 177   4                                                      writecom(0x0c);
 178   4                                                      flag=0;
 179   4                                                      write_ds(0x8E,0x00);
C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 4   

 180   4      
 181   4                                                      write_ds(0x80,shi_bcd(miao));
 182   4                                                      write_ds(0x82,shi_bcd(fen));
 183   4                                                      write_ds(0x84,shi_bcd(shi));
 184   4                                                      write_ds(0x86,shi_bcd(day));
 185   4                                                      write_ds(0x88,shi_bcd(month));
 186   4                                                      write_ds(0x8a,shi_bcd(week));
 187   4                                                      write_ds(0x8c,shi_bcd(year));
 188   4      
 189   4                                                      write_ds(0x8E,0x80);
 190   4                                                      break;
 191   4                              }
 192   3                      }
 193   2              }
 194   1              if(s1num!=0){
 195   2                      if(s2==0){
 196   3                              delay(5);
 197   3                              if(s2==0){
 198   4                                      while(!s2);di();
 199   4                                      switch(s1num)
 200   4                                      {
 201   5                                              case 1: miao++;
 202   5                                                              if(miao==60)miao=0;
 203   5                                                              write_sfm(10,miao);
 204   5                                                              writecom(0x80+0x40+10);
 205   5                                                              break;
 206   5                                              case 2: fen++;
 207   5                                                              if(fen==60)fen=0;
 208   5                                                              write_sfm(7,fen);
 209   5                                                              writecom(0x80+0x40+7);
 210   5                                                              break;
 211   5                                              case 3: shi++;
 212   5                                                              if(shi==24)shi=0;
 213   5                                                              write_sfm(4,shi);
 214   5                                                              writecom(0x80+0x40+4);
 215   5                                                              break;
 216   5                                              case 4: week++;
 217   5                                                              if(week==8)week=1;
 218   5                                                              write_week(week);
 219   5                                                              writecom(0x80+12);
 220   5                                                              break;
 221   5                                              case 5: day++;
 222   5                                                              if(day==32)day=1;
 223   5                                                              write_nyr(9,day);
 224   5                                                              writecom(0x80+9);
 225   5                                                              break;
 226   5                                              case 6: month++;
 227   5                                                              if(month==13)month=1;
 228   5                                                              write_nyr(6,month);
 229   5                                                              writecom(0x80+6);
 230   5                                                              break;
 231   5                                              case 7: year++;
 232   5                                                              if(year==100)year=0;
 233   5                                                              write_nyr(3,year);
 234   5                                                              writecom(0x80+3);
 235   5                                                              break;
 236   5                                      }
 237   4                              }
 238   3                      }
 239   2                      if(s3==0){
 240   3                              delay(5);
 241   3                              if(s3==0){
C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 5   

 242   4                                      while(!s3);di();
 243   4                                      switch(s1num)
 244   4                                      {
 245   5                                              case 1: miao--;
 246   5                                                              if(miao==-1)miao=59;
 247   5                                                              write_sfm(10,miao);
 248   5                                                              writecom(0x80+0x40+10);
 249   5                                                              break;
 250   5                                              case 2: fen--;
 251   5                                                              if(fen==-1)fen=59;
 252   5                                                              write_sfm(7,fen);
 253   5                                                              writecom(0x80+0x40+7);
 254   5                                                              break;
 255   5                                              case 3: shi--;
 256   5                                                              if(shi==-1)shi=23;
 257   5                                                              write_sfm(4,shi);
 258   5                                                              writecom(0x80+0x40+4);
 259   5                                                              break;
 260   5                                              case 4: week--;
 261   5                                                              if(week==0)week=7;
 262   5                                                              write_week(week);
 263   5                                                              writecom(0x80+12);
 264   5                                                              break;
 265   5                                              case 5: day--;
 266   5                                                              if(day==0)day=31;
 267   5                                                              write_nyr(9,day);
 268   5                                                              writecom(0x80+9);
 269   5                                                              break;
 270   5                                              case 6: month--;
 271   5                                                              if(month==0)month=12;
 272   5                                                              write_nyr(6,month);
 273   5                                                              writecom(0x80+6);
 274   5                                                              break;
 275   5                                              case 7: year--;
 276   5                                                              if(year==-1)year=99;
 277   5                                                              write_nyr(3,year);
 278   5                                                              writecom(0x80+3);
 279   5                                                              break;                  
 280   5                                      }
 281   4                              }
 282   3                      }
 283   2              }
 284   1      //      if(s4==0){
 285   1      //              delay(5);
 286   1      //              if(s4==0){
 287   1      //                      flag1=~flag1;
 288   1      //                      while(!s4);di();
 289   1      //                      if(flag1==0){
 290   1      //                              flag=0;
 291   1      //                              writecom(0x80+0x40);
 292   1      //                              writedata(' ');
 293   1      //                              writedata(' ');
 294   1      //                              writecom(0x0c);
 295   1      //
 296   1      //                              write_ds(0x8E,0x00);
 297   1      //
 298   1      //                              write_ds(0x80,miao);
 299   1      //                              write_ds(0x82,fen);
 300   1      //                              write_ds(0x84,shi);
 301   1      //
 302   1      //                              write_ds(0x8E,0x80);
 303   1      //                      }
C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 6   

 304   1      //                      else{
 305   1      //                              read_alarm();
 306   1      //                              miao=amiao;
 307   1      //                              fen=afen;
 308   1      //                              shi=ashi;
 309   1      //                              writecom(0x80+0x40);
 310   1      //                              writedata('R');
 311   1      //                              writedata('i');
 312   1      //                              writecom(0x80+0x40+3);
 313   1      //                              write_sfm(4,shi);
 314   1      //                              write_sfm(7,fen);
 315   1      //                              write_sfm(10,shi);
 316   1      //                      }
 317   1      //              }
 318   1      //      }
 319   1      }
 320          
 321          void main(){
 322   1              init();
 323   1              while(1){
 324   2                      keyscan();
 325   2      //              if(flag_ri==1){
 326   2      //                      di();
 327   2      //                      delay(100);
 328   2      //                      di();
 329   2      //                      delay(500);
 330   2      //              }
 331   2                      if(flag==0&&flag1==0){
 332   3                              keyscan();
 333   3                              miao=read_ds(0x81);
 334   3                              fen=read_ds(0x83);
 335   3                              shi=read_ds(0x85);
 336   3                              day=read_ds(0x87);
 337   3                              month=read_ds(0x89);
 338   3                              week=read_ds(0x8b);
 339   3                              year=read_ds(0x8d);
 340   3      
 341   3                              write_sfm_bcd(10,miao);
 342   3                              write_sfm_bcd(7,fen);
 343   3                              write_sfm_bcd(4,shi);
 344   3                              write_week(week);
 345   3                              write_nyr_bcd(3,year);
 346   3                              write_nyr_bcd(6,month);
 347   3                              write_nyr_bcd(9,day);
 348   3                      }
 349   2              }
 350   1      }
 351          
 352          //void exter() interrupt 2
 353          //{
 354          //      uchar c;
 355          //      flag_ri=1;
 356          //      c=read_ds(0x0c);
 357          //}


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1355    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     48      10
C51 COMPILER V9.01   MAIN                                                                  09/08/2017 22:38:01 PAGE 7   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
